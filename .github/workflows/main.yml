name: Build S22 Kernel (kernel_platform) - UFDT Final Fix

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'kernel_platform/**'
      - 'msm-kernel/**'
      - 'build_kernel_GKI.sh'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true

    - name: Setup Swap (8GB)
      run: |
        sudo swapoff /swapfile 2>/dev/null || true
        sudo dd if=/dev/zero of=/swapfile bs=1M count=8192
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        free -h

    - name: Install deps
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          bc bison build-essential flex libssl-dev \
          libncurses5-dev libelf-dev binutils-dev \
          qemu-user-static rsync wget tar git

    - name: Install ufdt_apply_overlay (AOSP prebuilts)
      run: |
        set -e
        git clone https://android.googlesource.com/platform/prebuilts/misc
        UFDT_BIN=$(find misc -type f -name ufdt_apply_overlay | head -n 1)
        if [ -z "$UFDT_BIN" ]; then
          echo "ufdt_apply_overlay n√£o encontrado"
          exit 1
        fi
        sudo cp "$UFDT_BIN" /usr/local/bin/
        sudo chmod +x /usr/local/bin/ufdt_apply_overlay
        which ufdt_apply_overlay

    - name: Prepare build
      run: |
        rm -rf kernel_platform/build/build-tools/path/linux-x86
        cat <<'EOF' > my_build.sh
        #!/bin/bash
        set -e
        export MAKEFLAGS="-j4"
        export HERMETIC_TOOLCHAIN=0
        export PATH=/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:$PATH
        bash build_kernel_GKI.sh
        EOF
        chmod +x my_build.sh

    - name: Build kernel
      run: ./my_build.sh

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: s22-kernel
        path: out/**/dist/*
