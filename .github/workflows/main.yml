name: Kernel Build (Waipio - Vendor Boot)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Instalar Dependências
        run: |
          sudo apt-get update
          sudo apt-get install -y git make gcc g++ python3 bc flex bison libssl-dev libelf-dev cpio unzip wget xz-utils zip

      - name: Configurar Toolchain (ZyC Clang)
        id: toolchain
        run: |
          # 1. Criar diretório da toolchain
          TOOLCHAIN_DIR="${{ github.workspace }}/toolchain"
          mkdir -p $TOOLCHAIN_DIR
          
          # 2. Baixar ZyC Clang (Versão estável e compatível com kernels modernos)
          # Esta toolchain já inclui Clang, LLD e binutils necessários.
          wget -q https://github.com/ZyCromerZ/Clang/releases/download/19.0.0git-20240212/ZyC-Clang-19.0.0git-20240212.tar.gz -O clang.tar.gz
          tar -xf clang.tar.gz -C $TOOLCHAIN_DIR
          
          # 3. Exportar Variáveis de Ambiente para o GitHub Actions
          echo "$TOOLCHAIN_DIR/bin" >> $GITHUB_PATH
          
          # Configurações de compilação
          {
            echo "ARCH=arm64"
            echo "SUBARCH=arm64"
            echo "KBUILD_COMPILER_STRING=$(clang --version | head -n 1)"
            echo "CLANG_PATH=$TOOLCHAIN_DIR/bin"
            echo "CROSS_COMPILE=aarch64-linux-gnu-"
            echo "CROSS_COMPILE_ARM32=arm-linux-gnueabi-"
            echo "CC=clang"
            echo "AR=llvm-ar"
            echo "NM=llvm-nm"
            echo "OBJCOPY=llvm-objcopy"
            echo "OBJDUMP=llvm-objdump"
            echo "STRIP=llvm-strip"
          } >> $GITHUB_ENV
          
          echo "Toolchain configurada com sucesso."
          $TOOLCHAIN_DIR/bin/clang --version

      - name: Executar Build do Kernel (vendor_boot)
        run: |
          # Dar permissão de execução aos scripts
          chmod +x *.sh
          chmod +x kernel_platform/build/*.sh
          
          # Executar o script de build principal
          ./build_kernel_GKI.sh
          
          # Localizar o diretório de saída (ajustado conforme a estrutura observada)
          # O script gera os arquivos em: out/msm-waipio-gki
          BUILD_OUT_DIR=$(find . -type d -name "msm-waipio-gki" | head -n 1)
          
          if [ -z "$BUILD_OUT_DIR" ]; then
            echo "Erro: Diretório de saída msm-waipio-gki não encontrado."
            # Listar diretórios para debug se falhar
            find . -maxdepth 4 -type d
            exit 1
          fi
          
          echo "BUILD_OUT_DIR=$BUILD_OUT_DIR" >> $GITHUB_ENV

      - name: Empacotar Artefatos
        run: |
          # Encontrar a imagem vendor_boot.img
          VENDOR_BOOT_IMG=$(find ${{ env.BUILD_OUT_DIR }} -name "vendor_boot.img" | head -n 1)
          
          if [ -z "$VENDOR_BOOT_IMG" ]; then
            echo "Erro: vendor_boot.img não encontrado."
            exit 1
          fi
          
          # Preparar pasta de módulos
          mkdir -p output/modules
          cp $VENDOR_BOOT_IMG output/waipio_vendor_boot.img
          
          # Tentar copiar módulos (.ko) se existirem
          find ${{ env.BUILD_OUT_DIR }} -name "*.ko" -exec cp {} output/modules/ \;
          
          # Criar o arquivo final
          cd output && zip -r ../waipio_kernel_artifacts.zip .

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: waipio-vendor-boot-build
          path: waipio_kernel_artifacts.zip
          retention-days: 7
