name: Build S22 Kernel (kernel_platform) - UFDT AOSP Fix

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'kernel_platform/**'
      - 'msm-kernel/**'
      - 'build_kernel_GKI.sh'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: Setup Swap Space (8GB)
      run: |
        sudo swapoff /swapfile 2>/dev/null || true
        sudo dd if=/dev/zero of=/swapfile bs=1M count=8192
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        free -h

    - name: Install Build Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          bc bison build-essential flex libssl-dev \
          libncurses5-dev libelf-dev binutils-dev \
          qemu-user-static rsync wget tar git

    - name: Download Clang r416183b (Android 12L)
      run: |
        TOOLCHAIN_DIR="kernel_platform/prebuilts-master/clang/host/linux-x86"
        CLANG_URL="https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/android12L-gsi/clang-r416183b.tar.gz"

        mkdir -p $TOOLCHAIN_DIR
        cd $TOOLCHAIN_DIR

        wget $CLANG_URL -O clang.tar.gz
        mkdir clang-r416183b
        tar -C clang-r416183b -xzf clang.tar.gz
        rm clang.tar.gz
        cd -

    # ðŸ”¥ FIX REAL: libufdt NÃƒO existe no repo â†’ baixar do AOSP
    - name: Download, Build and Install libufdt (AOSP)
      run: |
        set -e

        echo "ðŸ“¥ Clonando libufdt do AOSP"
        git clone https://android.googlesource.com/platform/system/libufdt

        cd libufdt

        echo "ðŸ”¨ Compilando libufdt"
        make

        echo "ðŸ“¦ Instalando ufdt_apply_overlay globalmente"
        sudo cp utils/src/ufdt_apply_overlay /usr/local/bin/
        sudo chmod +x /usr/local/bin/ufdt_apply_overlay

        which ufdt_apply_overlay
        ufdt_apply_overlay --help || true

        cd ..

    - name: Prepare Build Environment
      run: |
        # Remove toolchain hermÃ©tico bugado
        rm -rf kernel_platform/build/build-tools/path/linux-x86

        cat <<'EOF' > my_build.sh
        #!/bin/bash
        set -e

        export MAKEFLAGS="-j4"
        export HERMETIC_TOOLCHAIN=0

        export CLANG_PREBUILT_BIN=$(pwd)/kernel_platform/prebuilts-master/clang/host/linux-x86/clang-r416183b/bin

        export PATH=/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:$CLANG_PREBUILT_BIN

        export BISON=/usr/bin/bison
        export FLEX=/usr/bin/flex
        export M4=/usr/bin/m4

        bash build_kernel_GKI.sh
        EOF

        chmod +x my_build.sh

    - name: Build Kernel
      run: |
        ./my_build.sh

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: s22-kernel-artifacts
        path: |
          out/**/dist/Image
          out/**/dist/Image.lz4
          out/**/dist/vmlinux
          out/**/dist/modules.zip
          out/**/dist/*.dtbo
        if-no-files-found: error
        retention-days: 7
