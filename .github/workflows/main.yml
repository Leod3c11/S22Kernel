name: Kernel Build (Waipio - Vendor Boot | Proton Clang)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04

    env:
      ARCH: arm64
      SUBARCH: arm64
      CC: clang
      CROSS_COMPILE: aarch64-linux-gnu-
      CROSS_COMPILE_ARM32: arm-linux-gnueabi-
      LLVM: 1
      LLVM_IAS: 1

    steps:
      # ------------------------------------------------------------
      # Checkout
      # ------------------------------------------------------------
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------------------------------------------
      # Dependências
      # ------------------------------------------------------------
      - name: Instalar Dependências
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git make gcc g++ python3 bc flex bison \
            libssl-dev libelf-dev cpio unzip wget xz-utils zip \
            rsync file build-essential curl

      # ------------------------------------------------------------
      # Toolchain – Proton Clang
      # ------------------------------------------------------------
      - name: Configurar Toolchain (Proton Clang)
        run: |
          set -e

          TOOLCHAIN_DIR="${GITHUB_WORKSPACE}/toolchain"
          mkdir -p "$TOOLCHAIN_DIR"
          cd "$TOOLCHAIN_DIR"

          echo "Baixando Proton Clang..."
          git clone --depth=1 https://github.com/kdrag0n/proton-clang.git

          echo "${TOOLCHAIN_DIR}/proton-clang/bin" >> $GITHUB_PATH

          echo "AR=llvm-ar" >> $GITHUB_ENV
          echo "NM=llvm-nm" >> $GITHUB_ENV
          echo "OBJCOPY=llvm-objcopy" >> $GITHUB_ENV
          echo "OBJDUMP=llvm-objdump" >> $GITHUB_ENV
          echo "STRIP=llvm-strip" >> $GITHUB_ENV
          echo "LD=ld.lld" >> $GITHUB_ENV
          echo "KBUILD_COMPILER_STRING=$(clang --version | head -n 1)" >> $GITHUB_ENV

          clang --version

      # ------------------------------------------------------------
      # Build Kernel + vendor_boot
      # ------------------------------------------------------------
      - name: Build Kernel (Waipio GKI + vendor_boot)
        run: |
          set -e

          chmod +x *.sh || true
          chmod +x kernel_platform/build/*.sh || true

          echo ">>> Iniciando build do kernel"
          ./build_kernel_GKI.sh

          echo ">>> Procurando diretório de saída"
          BUILD_OUT_DIR=$(find . -type d -name "msm-waipio-gki" | head -n 1)

          if [ -z "$BUILD_OUT_DIR" ]; then
            echo "ERRO: diretório msm-waipio-gki não encontrado"
            find . -maxdepth 4 -type d
            exit 1
          fi

          echo "BUILD_OUT_DIR=$BUILD_OUT_DIR" >> $GITHUB_ENV
          echo "Diretório de saída: $BUILD_OUT_DIR"

      # ------------------------------------------------------------
      # Empacotar Artefatos
      # ------------------------------------------------------------
      - name: Empacotar vendor_boot e módulos
        run: |
          set -e

          mkdir -p output/modules

          VENDOR_BOOT_IMG=$(find "$BUILD_OUT_DIR" -name "vendor_boot.img" | head -n 1)

          if [ -z "$VENDOR_BOOT_IMG" ]; then
            echo "ERRO: vendor_boot.img não encontrado"
            find "$BUILD_OUT_DIR" -type f | head -n 200
            exit 1
          fi

          cp "$VENDOR_BOOT_IMG" output/vendor_boot.img

          find "$BUILD_OUT_DIR" -name "*.ko" -exec cp {} output/modules/ \; || true

          cd output
          zip -r ../waipio_vendor_boot_artifacts.zip .

      # ------------------------------------------------------------
      # Upload
      # ------------------------------------------------------------
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: waipio-vendor-boot-proton
          path: waipio_vendor_boot_artifacts.zip
          retention-days: 7
