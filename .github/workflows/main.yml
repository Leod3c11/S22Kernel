name: Build S22 Kernel (kernel_platform) - Final Optimized

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'kernel_platform/**'
      - 'msm-kernel/**'
      - 'build_kernel_GKI.sh'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: Setup Swap Space (Robust Memory Mitigation)
      run: |
        # Desativa qualquer swap existente no arquivo /swapfile
        sudo swapoff /swapfile 2>/dev/null || true
        
        # Cria um novo arquivo de swap de 8GB usando dd (mais robusto que fallocate em alguns ambientes)
        sudo dd if=/dev/zero of=/swapfile bs=1M count=8192
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        echo "Swap space created and activated."
        free -h

    - name: Install Build Dependencies
      run: |
        sudo apt-get update
        # Dependências essenciais para compilação de kernel Android (GKI)
        sudo apt-get install -y bc bison build-essential flex libssl-dev libncurses5-dev libelf-dev binutils-dev qemu-user-static rsync wget tar

    - name: Download and Configure Clang Toolchain (r416183b)
      run: |
        TOOLCHAIN_DIR="kernel_platform/prebuilts-master/clang/host/linux-x86"
        CLANG_TAR="clang-r416183b.tar.gz"
        CLANG_URL="https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/android12L-gsi/clang-r416183b.tar.gz"
        
        echo "Downloading Clang from: $CLANG_URL"
        mkdir -p $TOOLCHAIN_DIR
        cd $TOOLCHAIN_DIR
        
        # Baixar e extrair o toolchain necessário
        wget $CLANG_URL -O $CLANG_TAR
        mkdir clang-r416183b
        tar -C clang-r416183b -xzf $CLANG_TAR
        rm $CLANG_TAR
        
        # Voltar para o diretório raiz
        cd -

    - name: Prepare Environment and Fix Build Paths
      run: |
        # 1. Remover o diretório problemático que causa conflito com as ferramentas do sistema
        rm -rf kernel_platform/build/build-tools/path/linux-x86
        
        # 2. Criar e configurar o script de compilação
        cat <<EOF > my_build.sh
        #!/bin/bash
        # Definir o número máximo de threads para compilação (para economizar memória)
        # O runner padrão tem 2 cores, mas 4 threads é um bom equilíbrio para a fase de linkagem
        export MAKEFLAGS="-j4"
        
        # Desativar o modo hermético para usar o toolchain baixado
        export HERMETIC_TOOLCHAIN=0
        # Definir o caminho para o binário do Clang
        export CLANG_PREBUILT_BIN=kernel_platform/prebuilts-master/clang/host/linux-x86/clang-r416183b/bin
        
        # Forçar PATH para priorizar ferramentas do sistema e garantir que bison/flex sejam encontrados
        export PATH=/usr/bin:/bin:/usr/sbin:/sbin:\$PATH
        
        # Definir explicitamente ferramentas (segurança extra)
        export BISON=/usr/bin/bison
        export FLEX=/usr/bin/flex
        export M4=/usr/bin/m4
        
        # Executar o script de compilação principal
        bash build_kernel_GKI.sh
        EOF
        
        chmod +x my_build.sh

    - name: Build Kernel
      run: |
        # Executar o script personalizado
        ./my_build.sh

    - name: Find and Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: s22-kernel-artifacts
        path: |
          out/msm-waipio-waipio-gki/dist/Image.lz4
          out/msm-waipio-waipio-gki/dist/Image
          out/msm-waipio-waipio-gki/dist/modules.zip
          out/msm-waipio-waipio-gki/dist/vmlinux
        if-no-files-found: error
        retention-days: 7
