name: Build S22 Kernel (kernel_platform) - UFDT Fix

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'kernel_platform/**'
      - 'msm-kernel/**'
      - 'build_kernel_GKI.sh'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: Setup Swap Space (Robust Memory Mitigation)
      run: |
        sudo swapoff /swapfile 2>/dev/null || true
        sudo dd if=/dev/zero of=/swapfile bs=1M count=8192
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        free -h

    - name: Install Build Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          bc bison build-essential flex libssl-dev \
          libncurses5-dev libelf-dev binutils-dev \
          qemu-user-static rsync wget tar

    - name: Download and Configure Clang Toolchain (r416183b)
      run: |
        TOOLCHAIN_DIR="kernel_platform/prebuilts-master/clang/host/linux-x86"
        CLANG_TAR="clang-r416183b.tar.gz"
        CLANG_URL="https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/android12L-gsi/clang-r416183b.tar.gz"

        mkdir -p $TOOLCHAIN_DIR
        cd $TOOLCHAIN_DIR

        wget $CLANG_URL -O $CLANG_TAR
        mkdir clang-r416183b
        tar -C clang-r416183b -xzf $CLANG_TAR
        rm $CLANG_TAR
        cd -

    - name: Build libufdt (ufdt_apply_overlay)
      run: |
        cd kernel_platform/tools/libufdt
        make
        cd -

    - name: Install ufdt_apply_overlay globally (FIX DEFINITIVO)
      run: |
        sudo cp kernel_platform/tools/libufdt/utils/src/ufdt_apply_overlay /usr/local/bin/
        sudo chmod +x /usr/local/bin/ufdt_apply_overlay
        which ufdt_apply_overlay
        ufdt_apply_overlay --help || true

    - name: Prepare Environment
      run: |
        # Remove path hermético bugado
        rm -rf kernel_platform/build/build-tools/path/linux-x86

        cat <<'EOF' > my_build.sh
        #!/bin/bash
        set -e

        # Limitar paralelismo (memória)
        export MAKEFLAGS="-j4"

        # Desativar toolchain hermético
        export HERMETIC_TOOLCHAIN=0

        # Clang correto
        export CLANG_PREBUILT_BIN=$(pwd)/kernel_platform/prebuilts-master/clang/host/linux-x86/clang-r416183b/bin

        # PATH limpo e previsível
        export PATH=/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:$CLANG_PREBUILT_BIN

        # Ferramentas explícitas
        export BISON=/usr/bin/bison
        export FLEX=/usr/bin/flex
        export M4=/usr/bin/m4

        # Build principal
        bash build_kernel_GKI.sh
        EOF

        chmod +x my_build.sh

    - name: Build Kernel
      run: |
        ./my_build.sh

    - name: Find and Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: s22-kernel-artifacts
        path: |
          out/msm-waipio-waipio-gki/dist/Image
          out/msm-waipio-waipio-gki/dist/Image.lz4
          out/msm-waipio-waipio-gki/dist/vmlinux
          out/msm-waipio-waipio-gki/dist/modules.zip
          out/msm-waipio-waipio-gki/dist/*.dtbo
        if-no-files-found: error
        retention-days: 7
