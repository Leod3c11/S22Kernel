name: Kernel Build (Waipio GKI - Vendor Boot | AOSP Clang)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Instalar Dependências
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git build-essential python3 bc flex bison \
            libssl-dev libelf-dev cpio unzip wget xz-utils \
            file rsync curl lld llvm clang \
            libncurses-dev libc6-dev

      - name: Baixar Toolchain AOSP Clang
        run: |
          set -e
          TOOLCHAIN_DIR="${GITHUB_WORKSPACE}/prebuilts/clang/host/linux-x86"
          mkdir -p "$TOOLCHAIN_DIR"
          cd "$TOOLCHAIN_DIR"
          
          # Clang r416183b (recomendado para GKI)
          wget https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/clang-r416183b.tar.gz
          mkdir -p clang-r416183b
          tar -xzf clang-r416183b.tar.gz -C clang-r416183b
          
          # Adicionar ao PATH
          echo "${TOOLCHAIN_DIR}/clang-r416183b/bin" >> $GITHUB_PATH
          
          echo "CLANG_PATH=${TOOLCHAIN_DIR}/clang-r416183b/bin" >> $GITHUB_ENV

      - name: Build com AOSP Clang
        env:
          ARCH: arm64
          SUBARCH: arm64
          LLVM: 1
          LLVM_IAS: 1
          CC: clang
          LD: ld.lld
          CLANG_TRIPLE: aarch64-linux-gnu-
          CROSS_COMPILE: aarch64-linux-gnu-
          CROSS_COMPILE_ARM32: arm-linux-gnueabi-
        run: |
          set -e
          
          cd kernel_platform
          
          # Método simplificado
          ./build/build.sh \
            --config=./msm-kernel/build.config.msm.waipio.sec \
            --variant=gki \
            --skip-mrproper
          
          # Coletar artefatos
          find ../out -name "vendor_boot.img" -exec cp {} ../ \;
          find ../out -name "*.ko" -exec cp {} ../ \;

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-aosp-build
          path: |
            vendor_boot.img
            *.ko
          retention-days: 7
