name: Build Samsung GKI Kernel

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: ðŸ“¥ Checkout kernel source
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    # ===============================
    # DEPENDÃŠNCIAS DO SISTEMA
    # ===============================
    - name: ðŸ§° Install build dependencies (LLVM + tools)
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          bc bison build-essential flex libssl-dev \
          libncurses5-dev libelf-dev binutils-dev \
          rsync wget curl git unzip \
          clang lld llvm device-tree-compiler

        echo "âœ… Toolchain check"
        which clang
        which ld.lld
        clang --version
        ld.lld --version

    # ===============================
    # UFDT (DTBO OVERLAY TOOL)
    # ===============================
    - name: ðŸ“¥ Install ufdt_apply_overlay (AOSP prebuilt)
      run: |
        set -e

        git clone https://android.googlesource.com/platform/prebuilts/misc prebuilts-misc

        UFDT_BIN=$(find prebuilts-misc -type f -name ufdt_apply_overlay | head -n 1)

        if [ -z "$UFDT_BIN" ]; then
          echo "âŒ ufdt_apply_overlay nÃ£o encontrado nos prebuilts"
          exit 1
        fi

        echo "âœ… ufdt_apply_overlay encontrado em: $UFDT_BIN"
        sudo cp "$UFDT_BIN" /usr/local/bin/ufdt_apply_overlay
        sudo chmod +x /usr/local/bin/ufdt_apply_overlay

        which ufdt_apply_overlay
        ufdt_apply_overlay --help || true

    # ===============================
    # VARIÃVEIS LLVM (OBRIGATÃ“RIO GKI)
    # ===============================
    - name: âš™ï¸ Export LLVM environment
      run: |
        echo "LLVM=1" >> $GITHUB_ENV
        echo "LLVM_IAS=1" >> $GITHUB_ENV
        echo "LD=ld.lld" >> $GITHUB_ENV

    # ===============================
    # BUILD DO GKI
    # ===============================
    - name: ðŸ”¨ Build GKI Kernel
      run: |
        set -e

        export ARCH=arm64
        export SUBARCH=arm64
        export LLVM=1
        export LLVM_IAS=1
        export LD=ld.lld

        # Ajuste se necessÃ¡rio
        export BUILD_CONFIG=kernel_platform/common/build.config.gki

        cd kernel_platform

        bash build/build.sh

    # ===============================
    # ARTEFATOS
    # ===============================
    - name: ðŸ“¦ Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kernel-output
        path: |
          out/**/Image
          out/**/Image.gz
          out/**/Image.lz4
          out/**/dtbo.img
          out/**/vendor_boot.img
