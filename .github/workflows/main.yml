name: Build vendor_boot.img (Fixed)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: 1

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential flex bison git-lfs libssl-dev libelf-dev \
            python3 python3-pip python-is-python3 repo \
            cpio zip unzip tar gzip bzip2 lz4 liblz4-tool sed tr coreutils findutils

      - name: Fix PATH and Run Build
        run: |
          # Criar um wrapper para o script de build que preserva o PATH do sistema
          # O script original parece estar limpando o PATH ou definindo-o de forma restritiva.
          
          export ANDROID_BUILD_TOP=$(pwd)
          export OUT_DIR=$(pwd)/out
          
          # Garantir permissões
          chmod +x build_kernel_GKI.sh
          find kernel_platform/build/ -name "*.sh" -exec chmod +x {} +
          chmod +x kernel_platform/build/brunch
          
          # Executar o build injetando o PATH do sistema no início da variável PATH
          # para que comandos como 'nproc', 'sed', etc, sejam encontrados em /usr/bin ou /bin
          
          SYSTEM_PATH=$PATH
          
          # Algumas builds da Samsung/Qualcomm esperam que o PATH seja manipulado.
          # Vamos tentar rodar o script garantindo que os binários essenciais existam.
          # Se o script interno fizer "PATH=...", ele vai quebrar. 
          # Uma solução comum é linkar ferramentas essenciais para dentro de uma das pastas que o script define.
          
          mkdir -p kernel_platform/prebuilts/gcc/linux-x86/host/bin
          for cmd in nproc readlink sed tr grep awk find xargs; do
            ln -sf $(which $cmd) kernel_platform/prebuilts/gcc/linux-x86/host/bin/$cmd
          done
          export PATH=$(pwd)/kernel_platform/prebuilts/gcc/linux-x86/host/bin:$PATH
          
          ./build_kernel_GKI.sh

      - name: Verify and Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kernel-build-output
          path: |
            out/**/dist/vendor_boot.img
            out/**/dist/Image
            out/**/dist/*.ko
          if-no-files-found: warn
