name: Build vendor_boot.img

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'kernel_platform/**'
      - 'build_kernel_GKI.sh'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: 1

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential flex bison git-lfs libssl-dev libelf-dev \
            python3 python3-pip python-is-python3 repo \
            cpio zip unzip tar gzip bzip2 lz4 liblz4-tool

      - name: Set Environment Variables
        run: |
          echo "ANDROID_BUILD_TOP=$(pwd)" >> $GITHUB_ENV
          echo "OUT_DIR=$(pwd)/out" >> $GITHUB_ENV
          # O script original usa caminhos relativos para toolchains que podem não existir no repo.
          # Vamos garantir que o PATH inclua ferramentas necessárias se o repo as fornecer.
          echo "$(pwd)/kernel_platform/gcc/linux-x86_64/x86_64-linux-gnu/bin" >> $GITHUB_PATH

      - name: Run Build Script
        run: |
          chmod +x build_kernel_GKI.sh
          chmod +x kernel_platform/build/android/prepare_vendor.sh
          chmod +x kernel_platform/build/build.sh
          chmod +x kernel_platform/build/brunch
          
          # O script build_kernel_GKI.sh executa o prepare_vendor.sh
          # Vamos rodar o script principal do usuário
          ./build_kernel_GKI.sh

      - name: Verify and Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kernel-build-output
          path: |
            out/msm-waipio-waipio-gki/dist/vendor_boot.img
            out/msm-waipio-waipio-gki/dist/Image
            out/msm-waipio-waipio-gki/dist/*.ko
          if-no-files-found: warn
