name: Build S22 Kernel (Image + DTBO + vendor_dlkm)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
    # ===============================
    # CHECKOUT
    # ===============================
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: true

    # ===============================
    # DEPEND√äNCIAS
    # ===============================
    - name: Install Build Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          bc bison build-essential flex libssl-dev \
          libncurses5-dev libelf-dev binutils-dev \
          rsync wget tar cpio \
          clang lld llvm device-tree-compiler

    # ===============================
    # SWAP (ALTERADO APENAS AQUI)
    # ===============================
    - name: Setup Swap
      run: |
        sudo swapoff -a || true

        echo "üß† Criando swap grande (16GB)"
        sudo fallocate -l 16G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile

        echo "‚öôÔ∏è Ajustando swappiness"
        sudo sysctl vm.swappiness=90

        echo "üìä Mem√≥ria ap√≥s swap:"
        free -h
        swapon --show

    # ===============================
    # CACHE CLANG
    # ===============================
    - name: Cache Clang
      uses: actions/cache@v4
      with:
        path: kernel_platform/prebuilts-master/clang/host/linux-x86/clang-r416183b
        key: clang-r416183b

    # ===============================
    # CLANG AOSP
    # ===============================
    - name: Setup Clang
      run: |
        TOOLCHAIN_DIR=kernel_platform/prebuilts-master/clang/host/linux-x86
        CLANG_URL=https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/android12L-gsi/clang-r416183b.tar.gz

        mkdir -p $TOOLCHAIN_DIR
        cd $TOOLCHAIN_DIR

        if [ ! -d clang-r416183b ]; then
          wget $CLANG_URL -O clang.tar.gz
          mkdir clang-r416183b
          tar -C clang-r416183b -xzf clang.tar.gz
          rm clang.tar.gz
        fi

    # ===============================
    # PREPARE BUILD SCRIPT
    # ===============================
    - name: Prepare Build Script
      run: |
        cat <<'EOF' > build.sh
        #!/bin/bash
        set -e

        ################ TARGET ################
        export BUILD_TARGET=g0q_gbl_openx
        export MODEL=${BUILD_TARGET%%_*}
        export REGION=$(echo $BUILD_TARGET | cut -d'_' -f2)
        export CARRIER=$(echo $BUILD_TARGET | cut -d'_' -f3)
        export TARGET_BUILD_VARIANT=user

        ################ CHIPSET ################
        export CHIPSET_NAME=waipio
        export TARGET_PRODUCT=gki
        export TARGET_BOARD_PLATFORM=gki
        export ANDROID_BUILD_TOP=$(pwd)

        export ANDROID_PRODUCT_OUT=$ANDROID_BUILD_TOP/out/target/product/$MODEL
        export OUT_DIR=$ANDROID_BUILD_TOP/out/msm-$CHIPSET_NAME-$CHIPSET_NAME-$TARGET_PRODUCT

        ################ TOOLCHAIN ################
        export MAKEFLAGS="-j4"
        export HERMETIC_TOOLCHAIN=0

        export CLANG_PREBUILT_BIN=$ANDROID_BUILD_TOP/kernel_platform/prebuilts-master/clang/host/linux-x86/clang-r416183b/bin
        export PATH=$CLANG_PREBUILT_BIN:$PATH

        export LLVM=1
        export LLVM_IAS=1
        export LD=ld.lld

        ################ BUILD ################
        bash build_kernel_GKI.sh
        EOF

        chmod +x build.sh

    # ===============================
    # BUILD KERNEL
    # ===============================
    - name: Build Kernel
      run: ./build.sh || true

    # ===============================
    # COLETAR ARTEFATOS
    # ===============================
    - name: Collect Kernel Image + DTBO
      run: |
        mkdir -p out-final
        find out/ -name "Image*" -exec cp {} out-final/ \;
        find out/ -name "dtbo.img" -exec cp {} out-final/ \;

    # ===============================
    # BUILD VENDOR_DLKM.IMG
    # ===============================
    - name: Build vendor_dlkm.img
      run: |
        echo "üì¶ Preparando m√≥dulos"
        MODDIR=vendor_dlkm_root/lib/modules
        mkdir -p $MODDIR

        find out/ -name "*.ko" -exec cp {} $MODDIR \;

        depmod -b vendor_dlkm_root -F out/$(find out -name System.map | head -n1) 0 || true

        echo "üì¶ Criando vendor_dlkm.img"
        mkdir -p out-final
        dd if=/dev/zero of=vendor_dlkm.img bs=1M count=64
        mkfs.ext4 -F vendor_dlkm.img
        mkdir mnt
        sudo mount vendor_dlkm.img mnt
        sudo tar -C vendor_dlkm_root -cf - . | sudo tar -C mnt -xf -
        sudo umount mnt

        mv vendor_dlkm.img out-final/

    # ===============================
    # COMPACTAR
    # ===============================
    - name: Compress Output
      run: |
        tar -czf kernel-release.tar.gz out-final

    # ===============================
    # UPLOAD
    # ===============================
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: s22-kernel-release
        path: kernel-release.tar.gz
        retention-days: 7
