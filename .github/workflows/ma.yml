name: Build S22 Kernel (Image + DTBO + vendor_dlkm)

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'kernel_platform/**'
      - 'msm-kernel/**'
      - 'build_kernel_GKI.sh'

jobs:
  build:
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
    # ===============================
    # CHECKOUT
    # ===============================
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: true

    # ===============================
    # DEPEND√äNCIAS DO SISTEMA
    # ===============================
    - name: Install Build Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          bc bison build-essential flex libssl-dev \
          libncurses5-dev libelf-dev binutils-dev \
          qemu-user-static rsync wget tar \
          clang lld llvm device-tree-compiler e2fsprogs

        clang --version
        ld.lld --version

    # ===============================
    # SWAP (ALTERADO)
    # ===============================
    - name: Setup Swap Space
      run: |
        echo "üß† Criando swap de 16GB"
        sudo swapoff -a || true
        sudo dd if=/dev/zero of=/swapfile bs=1M count=16384
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        free -h
        swapon --show

    # ===============================
    # CACHE DO CLANG AOSP
    # ===============================
    - name: Cache Clang Toolchain
      uses: actions/cache@v4
      with:
        path: kernel_platform/prebuilts-master/clang/host/linux-x86/clang-r416183b
        key: clang-r416183b

    # ===============================
    # CLANG AOSP
    # ===============================
    - name: Download and Configure Clang Toolchain
      run: |
        TOOLCHAIN_DIR="kernel_platform/prebuilts-master/clang/host/linux-x86"
        CLANG_TAR="clang-r416183b.tar.gz"
        CLANG_URL="https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/android12L-gsi/clang-r416183b.tar.gz"

        mkdir -p $TOOLCHAIN_DIR
        cd $TOOLCHAIN_DIR

        if [ ! -d clang-r416183b ]; then
          wget $CLANG_URL -O $CLANG_TAR
          mkdir clang-r416183b
          tar -C clang-r416183b -xzf $CLANG_TAR
          rm $CLANG_TAR
        fi

        cd -

    # ===============================
    # PREPARAR AMBIENTE + TARGET CONFIG
    # ===============================
    - name: Prepare Build Environment
      run: |
        rm -rf kernel_platform/build/build-tools/path/linux-x86

        cat <<'EOF' > my_build.sh
        #!/bin/bash
        set -e

        #################################
        # TARGET CONFIG
        #################################
        export BUILD_TARGET=g0q_gbl_openx

        export MODEL=$(echo ${BUILD_TARGET} | cut -d'_' -f1)
        export PROJECT_NAME=${MODEL}
        export REGION=$(echo ${BUILD_TARGET} | cut -d'_' -f2)
        export CARRIER=$(echo ${BUILD_TARGET} | cut -d'_' -f3)
        export TARGET_BUILD_VARIANT=user

        #################################
        # CHIPSET
        #################################
        export CHIPSET_NAME=waipio
        export ANDROID_BUILD_TOP=$(pwd)

        export TARGET_PRODUCT=gki
        export TARGET_BOARD_PLATFORM=gki

        export ANDROID_PRODUCT_OUT=${ANDROID_BUILD_TOP}/out/target/product/${MODEL}
        export OUT_DIR=${ANDROID_BUILD_TOP}/out/msm-${CHIPSET_NAME}-${CHIPSET_NAME}-${TARGET_PRODUCT}

        #################################
        # TOOLCHAIN
        #################################
        export MAKEFLAGS="-j4"
        export HERMETIC_TOOLCHAIN=0

        export CLANG_PREBUILT_BIN=kernel_platform/prebuilts-master/clang/host/linux-x86/clang-r416183b/bin

        export LLVM=1
        export LLVM_IAS=1
        export LD=ld.lld

        export PATH=$CLANG_PREBUILT_BIN:/usr/bin:/bin:/usr/sbin:/sbin:$PATH

        export BISON=/usr/bin/bison
        export FLEX=/usr/bin/flex
        export M4=/usr/bin/m4

        #################################
        # BUILD
        #################################
        bash build_kernel_GKI.sh
        EOF

        chmod +x my_build.sh

    # ===============================
    # BUILD DO KERNEL
    # ===============================
    - name: Build Kernel
      continue-on-error: true
      run: |
        ./my_build.sh || echo "‚ö†Ô∏è Build finalizado com erros"

    # ===============================
    # COLETAR IMAGE + DTBO
    # ===============================
    - name: Collect Kernel Image and DTBO
      run: |
        mkdir -p kernel-out

        find out/ -type f \( \
          -name "Image" \
          -o -name "Image.gz" \
          -o -name "Image.lz4" \
        \) -exec cp {} kernel-out/ \;

        find out/ -type f -name "dtbo.img" -exec cp {} kernel-out/ \;

    # ===============================
    # BUILD VENDOR_DLKM.IMG (NOVO)
    # ===============================
    - name: Build vendor_dlkm.img
      run: |
        echo "üì¶ Criando vendor_dlkm.img"

        ROOT=vendor_dlkm_root
        MODDIR=$ROOT/lib/modules

        mkdir -p $MODDIR

        find out/ -name "*.ko" -exec cp {} $MODDIR \;

        dd if=/dev/zero of=vendor_dlkm.img bs=1M count=64
        mkfs.ext4 -F vendor_dlkm.img

        mkdir mnt
        sudo mount vendor_dlkm.img mnt
        sudo cp -r $ROOT/* mnt/
        sudo umount mnt

        mv vendor_dlkm.img kernel-out/

    # ===============================
    # COMPACTAR
    # ===============================
    - name: Compress Kernel Output
      run: |
        tar -czf kernel-basic.tar.gz kernel-out
        ls -lh kernel-basic.tar.gz

    # ===============================
    # UPLOAD
    # ===============================
    - name: Upload Kernel Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: s22-kernel-image-dtbo-vendor_dlkm
        path: kernel-basic.tar.gz
        retention-days: 7
