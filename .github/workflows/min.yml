name: Build S22 Kernel Modules Only (GKI)

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'kernel_platform/**'
      - '.github/workflows/build-modules-only.yml'

jobs:
  build-modules:
    runs-on: ubuntu-latest

    steps:
    # ===============================
    # CHECKOUT
    # ===============================
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: true

    # ===============================
    # DEPEND√äNCIAS
    # ===============================
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          bc bison build-essential flex libssl-dev \
          libncurses5-dev libelf-dev \
          clang lld llvm \
          zip rsync

        which clang
        which ld.lld
        clang --version
        ld.lld --version

    # ===============================
    # CLANG AOSP
    # ===============================
    - name: Download AOSP Clang r416183b
      run: |
        set -e

        TOOLCHAIN_DIR="kernel_platform/prebuilts-master/clang/host/linux-x86"
        CLANG_URL="https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/android12L-gsi/clang-r416183b.tar.gz"

        mkdir -p "$TOOLCHAIN_DIR"
        cd "$TOOLCHAIN_DIR"

        wget "$CLANG_URL" -O clang.tar.gz
        mkdir clang-r416183b
        tar -xzf clang.tar.gz -C clang-r416183b
        rm clang.tar.gz

    # ===============================
    # DETECTAR KERNEL DIR
    # ===============================
    - name: Detect kernel directory (gki_defconfig)
      run: |
        set -e

        echo "üîç Procurando gki_defconfig..."

        if [ -f kernel_platform/common/arch/arm64/configs/gki_defconfig ]; then
          echo "KERNEL_DIR=kernel_platform/common" >> $GITHUB_ENV
        elif [ -f kernel_platform/msm-kernel/arch/arm64/configs/gki_defconfig ]; then
          echo "KERNEL_DIR=kernel_platform/msm-kernel" >> $GITHUB_ENV
        else
          echo "‚ùå gki_defconfig n√£o encontrado"
          echo "üìÇ Dump parcial:"
          ls -R kernel_platform | head -n 200
          exit 1
        fi

        echo "‚úÖ Kernel dir detectado:"
        cat $GITHUB_ENV

    # ===============================
    # BUILD APENAS DOS M√ìDULOS
    # ===============================
    - name: Build kernel modules only
      run: |
        set -e

        export HERMETIC_TOOLCHAIN=0

        export LLVM=1
        export LLVM_IAS=1
        export LD=ld.lld

        export CLANG_PREBUILT_BIN=kernel_platform/prebuilts-master/clang/host/linux-x86/clang-r416183b/bin
        export PATH="$CLANG_PREBUILT_BIN:/usr/bin:/bin:/usr/sbin:/sbin:$PATH"

        export BISON=/usr/bin/bison
        export FLEX=/usr/bin/flex
        export M4=/usr/bin/m4

        export MAKEFLAGS="-j$(nproc)"

        OUT_DIR="$PWD/out"
        MOD_INSTALL_DIR="$PWD/out/modules"

        mkdir -p "$OUT_DIR" "$MOD_INSTALL_DIR"

        echo "‚öôÔ∏è gki_defconfig"
        make -C "$KERNEL_DIR" O="$OUT_DIR" gki_defconfig

        echo "üß© modules_prepare"
        make -C "$KERNEL_DIR" O="$OUT_DIR" modules_prepare

        echo "üî® Compilando SOMENTE m√≥dulos"
        make -C "$KERNEL_DIR" O="$OUT_DIR" modules

        echo "üì¶ Instalando m√≥dulos"
        make -C "$KERNEL_DIR" \
          O="$OUT_DIR" \
          modules_install \
          INSTALL_MOD_PATH="$MOD_INSTALL_DIR"

        echo "üì¶ Criando zip"
        cd "$MOD_INSTALL_DIR"
        zip -r "$GITHUB_WORKSPACE/modules-only.zip" .

    # ===============================
    # ARTEFATOS
    # ===============================
    - name: Upload modules-only.zip
      uses: actions/upload-artifact@v4
      with:
        name: s22-kernel-modules-only
        path: modules-only.zip
        retention-days: 7
